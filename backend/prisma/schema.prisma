generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  name          String
  phone         String         @unique
  email         String?        @unique
  type          UserType
  orders        Order[]
  products      Product[]      @relation("SellerProducts")
  cart          Cart?
  subscriptions Subscription[]
  password      String
  address       String         @default("Unknown")
  createdAt     DateTime       @default(now())
}

enum UserType {
  PERSONAL
  BUSINESS
  SELLER
}

model Order {
  id            String        @id @default(uuid())
  user          User          @relation(fields: [userId], references: [id])
  userId        String
  items         OrderItem[]
  status        OrderStatus   @default(PENDING)
  paymentstatus PaymentStatus @default(PENDING)
  placedAt      DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

enum OrderStatus {
  PENDING
  ONGOING
  FULFILLED
}

enum PaymentStatus {
  PENDING
  FULFILLED
}

model OrderItem {
  id        String  @id @default(uuid())
  order     Order   @relation(fields: [orderId], references: [id])
  orderId   String
  product   Product @relation(fields: [productId], references: [id])
  productId String
  quantity  Float
  price     Float   @default(0) // Price at the time of order
  cost      Float   @default(0) // Cost at the time of order
}

model Product {
  id                String             @id @default(uuid())
  name              String
  description       String?
  price             Float
  cost              Float              @default(0)
  unit              String // e.g., "KG", "PCS"
  available         Boolean            @default(true)
  imageUrl          String             @default("https://placehold.co/400")
  sellerId          String
  seller            User               @relation("SellerProducts", fields: [sellerId], references: [id])
  OrderItem         OrderItem[]
  CartItem          CartItem[]
  SubscriptionItem  SubscriptionItem[]
}

model Cart {
  id        String     @id @default(uuid())
  user      User       @relation(fields: [userId], references: [id])
  userId    String     @unique // one cart per user
  items     CartItem[]
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String  @id @default(uuid())
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartId    String
  product   Product @relation(fields: [productId], references: [id])
  productId String
  quantity  Float

  @@unique([cartId, productId]) // no duplicate products in the same cart
}

model Subscription {
  id         String               @id @default(uuid())
  user       User                 @relation(fields: [userId], references: [id])
  userId     String
  name       String               // user-given label e.g. "Weekly Groceries"
  items      SubscriptionItem[]
  active     Boolean              @default(true)
  frequency  SubscriptionFrequency
  dayOfWeek  Int?                 // 0=Sun â€¦ 6=Sat, only used for WEEKLY
  hour       Int                  // 0-23 (local server time)
  minute     Int                  @default(0) // 0-59
  nextRunAt  DateTime             // pre-computed next trigger time
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
}

enum SubscriptionFrequency {
  DAILY
  WEEKLY
}

model SubscriptionItem {
  id             String       @id @default(uuid())
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  subscriptionId String
  product        Product      @relation(fields: [productId], references: [id])
  productId      String
  quantity       Float

  @@unique([subscriptionId, productId])
}
